<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relay Setting Calculator</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    h1 { text-align: center; color: #1f2937; margin-bottom: 25px; }
    .calculator { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    label { font-weight: 600; font-size: 14px; color: #4b5563; margin-bottom: 5px; display: block; }
    input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; box-sizing: border-box; font-size: 16px; transition: border-color 0.2s; }
    input:focus { border-color: #2563eb; outline: none; }
    
    .tx-group {
      grid-column: 1 / -1;
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-top: 5px;
    }
    .tx-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .tx-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .tx-title { font-size: 13px; font-weight: 700; color: #2563eb; margin-bottom: 8px; grid-column: 1 / -1; }

    button { grid-column: 1 / -1; background: #2563eb; color: #fff; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: background 0.2s; width: 100%; }
    button:hover { background: #1d4ed8; }
    
    .output { margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
    .highlight { font-size: 18px; font-weight: 700; color: #111827; margin: 25px 0 10px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; }
    
    /* Responsive Table Wrapper */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: white;
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; /* Forces scroll on small screens */ }
    th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: center; }
    th { background: #f3f4f6; color: #374151; font-weight: 600; }
    .formula { font-size: 11px; color: #6b7280; display: block; margin-top: 4px; }
    
    .relay-options { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
    .pill { padding: 8px 20px; border-radius: 20px; background: #e5e7eb; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; user-select: none; white-space: nowrap; }
    .pill:hover { background: #d1d5db; }
    .pill.active { background: #2563eb; color: #fff; transform: scale(1.05); }

    .system-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .info-box { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 14px; }
    .info-box span { display: block; font-weight: bold; color: #2563eb; }

    .credits { margin-top: 40px; text-align: center; font-size: 13px; color: #9ca3af; }
    .heart { position: fixed; font-size: 20px; color: #ef4444; pointer-events: none; animation: floatUp 1.5s ease-out forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }

    /* Mobile Responsive Styles */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .calculator { padding: 15px; }
      h1 { font-size: 1.5rem; margin-bottom: 20px; }
      
      .input-grid { grid-template-columns: 1fr; gap: 15px; }
      .tx-row { grid-template-columns: 1fr; gap: 10px; }
      
      .system-info { grid-template-columns: 1fr; }
      
      .relay-options { flex-direction: column; gap: 8px; }
      .pill { width: 100%; text-align: center; box-sizing: border-box; }
      .pill.active { transform: none; background: #2563eb; }

      th, td { padding: 8px; font-size: 14px; }
    }
  </style>
</head>
<body>

  <h1>Relay Setting Calculator</h1>
  <div class="calculator">
    <div class="input-grid">
      <div>
        <label>System Voltage (kV)</label>
        <input type="number" id="voltage" step="0.01" placeholder="e.g. 11 or 33">
      </div>
      <div>
        <label>Consumer Demand (kVA)</label>
        <input type="number" id="demand" step="0.01" placeholder="e.g. 500">
      </div>
      
      <!-- New Transformer Count Input -->
      <div style="grid-column: 1 / -1;">
        <label>Number of Transformers Connected</label>
        <input type="number" id="numTransformers" value="1" min="1" max="10" onchange="updateTransformerInputs()">
      </div>

      <!-- Container for Dynamic Transformer Inputs -->
      <div id="transformers-container" class="tx-group">
        <!-- Default Content for 1 TX -->
        <div class="tx-row">
            <div class="tx-title">Transformer 1</div>
            <div>
                <label>Rating (kVA)</label>
                <input type="number" class="tx-rating" step="0.01" placeholder="e.g. 1000">
            </div>
            <div>
                <label>Impedance (Z%)</label>
                <input type="number" class="tx-imp" step="0.01" placeholder="e.g. 5">
            </div>
        </div>
      </div>

      <div>
        <label>% Overload Margin Allowed</label>
        <input type="number" id="overload" step="0.01" placeholder="e.g. 10">
      </div>
      <div>
        <label>CT Ratio (Primary / 1)</label>
        <input type="number" id="ctr" step="1" placeholder="e.g. 100">
      </div>
      <button onclick="calculate()">Calculate Settings</button>
    </div>

    <div id="results" class="output" style="display:none;">
      
      <!-- Individual Transformer Table -->
      <div class="highlight" style="margin-top:0;">Individual Transformer Parameters</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Transformer</th>
              <th>Rating (kVA)</th>
              <th>Z (%)</th>
              <th>Rated Current</th>
              <th>SC Current</th>
              <th>Inrush (12x)</th>
            </tr>
          </thead>
          <tbody id="txTableBody">
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>

      <!-- System Totals -->
      <div class="highlight">System Totals</div>
      <div class="system-info">
        <div class="info-box">Consumer Load <span id="consumerLoad"></span></div>
        <div class="info-box">Total HV Rated Current <span id="hvRated"></span></div>
        <div class="info-box">Total Short Circuit <span id="shortCircuit"></span></div>
        <div class="info-box">Total Inrush (12x) <span id="inrushCurrent"></span></div>
      </div>

      <div class="highlight">Calculated Ideal Primary Values</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Setting</th>
              <th>I&gt; (O/C)</th>
              <th>I&gt;&gt; (Hi-Set)</th>
              <th>I&gt;&gt;&gt; (Inst)</th>
              <th>Ie&gt; (E/F)</th>
              <th>Ie&gt;&gt; (Hi-E/F)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Primary Amps</td>
              <td id="i1"></td>
              <td id="i2"></td>
              <td id="i5"></td>
              <td id="i3"></td>
              <td id="i4"></td>
            </tr>
            <tr>
              <td>Calculation</td>
              <td>Load + Margin</td>
              <td style="color:#d97706; font-weight:bold;">Depends on Time*</td>
              <td>90% of SC</td>
              <td>20% Rated</td>
              <td>100% Rated</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="relay-options">
        <span class="pill" onclick="selectRelay('ashida')">Ashida (Fast)</span>
        <span class="pill" onclick="selectRelay('micom')">Micom P122</span>
        <span class="pill" onclick="selectRelay('ref615')">ABB REF615</span>
      </div>

      <div id="relaySpecificResult" style="display:none;">
        <div class="highlight">Final Relay Settings</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th id="settingLabel">Pickup (Sec)</th>
                <th>I&gt;</th>
                <th>I&gt;&gt;</th>
                <th>I&gt;&gt;&gt;</th>
                <th>Ie&gt;</th>
                <th>Ie&gt;&gt;</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Current</td>
                <td id="ri1"></td>
                <td id="ri2"></td>
                <td id="ri5"></td>
                <td id="ri3"></td>
                <td id="ri4"></td>
              </tr>
              <tr>
                <td>Time (TMS/sec)</td>
                <td id="rt1"></td>
                <td id="rt2" style="font-weight:bold; color:#2563eb;"></td>
                <td id="rt5"></td>
                <td id="rt3"></td>
                <td id="rt4"></td>
              </tr>
              <tr>
                <td>Logic Used</td>
                <td>Normal Inverse</td>
                <td id="logicMsg" style="font-size:11px; color:#666;"></td>
                <td>Instant</td>
                <td>Normal Inverse</td>
                <td>Definite Time</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <div class="credits">
    Designed with <span onclick="spawnHearts()" style="cursor:pointer;">❤️</span> by mr2000
  </div>

  <script>
    // --- DATASETS ---
    const ashidaData = {
      "I>": [0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0],
      "I>>": [1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 14.0, 16.0, 18.0, 20.0],
      "Ie>": [0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
      "Ie>>": [0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]
    };

    let relayChoice = null;

    // --- UTILS ---
    function findNearestHigher(value, arr) {
      if(value > arr[arr.length-1]) return arr[arr.length-1]; 
      for (let i = 0; i < arr.length; i++) {
        if (arr[i] >= value) return arr[i];
      }
      return arr[0];
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    // --- DYNAMIC INPUTS ---
    function updateTransformerInputs() {
        const count = parseInt(document.getElementById('numTransformers').value) || 1;
        const container = document.getElementById('transformers-container');
        
        // Simple rebuild logic - in production you might want to preserve values
        // For this demo, we will try to preserve values if index exists
        const oldRatings = document.querySelectorAll('.tx-rating');
        const oldImps = document.querySelectorAll('.tx-imp');
        const storedValues = [];
        for(let i=0; i < oldRatings.length; i++) {
            storedValues.push({
                rating: oldRatings[i].value,
                imp: oldImps[i].value
            });
        }

        container.innerHTML = ''; // Clear

        for (let i = 0; i < count; i++) {
            const row = document.createElement('div');
            row.className = 'tx-row';
            
            const ratingVal = (storedValues[i] && storedValues[i].rating) ? storedValues[i].rating : '';
            const impVal = (storedValues[i] && storedValues[i].imp) ? storedValues[i].imp : '';

            row.innerHTML = `
                <div class="tx-title">Transformer ${i + 1}</div>
                <div>
                    <label>Rating (kVA)</label>
                    <input type="number" class="tx-rating" step="0.01" placeholder="e.g. 1000" value="${ratingVal}">
                </div>
                <div>
                    <label>Impedance (Z%)</label>
                    <input type="number" class="tx-imp" step="0.01" placeholder="e.g. 5" value="${impVal}">
                </div>
            `;
            container.appendChild(row);
        }
    }

    // --- CALCULATION ---
    function calculate() {
      const V = parseFloat(document.getElementById("voltage").value);
      const demand = parseFloat(document.getElementById("demand").value);
      const overload = parseFloat(document.getElementById("overload").value);
      const ctr = parseFloat(document.getElementById("ctr").value);
      
      // Get all Transformer inputs
      const ratingInputs = document.querySelectorAll('.tx-rating');
      const impInputs = document.querySelectorAll('.tx-imp');
      const txTableBody = document.getElementById('txTableBody');

      // Validation
      if(isNaN(V) || isNaN(demand) || isNaN(overload) || isNaN(ctr)) {
        alert("Please fill all common inputs correctly!");
        return;
      }
      
      let totalHvRated = 0;
      let totalShortCircuit = 0;
      let totalInrush = 0;
      let inputsValid = true;
      let txRowsHTML = "";

      // Loop through transformers to sum up Capacities and Short Circuit contributions
      for(let i=0; i < ratingInputs.length; i++) {
          const rating = parseFloat(ratingInputs[i].value);
          const z = parseFloat(impInputs[i].value);
          
          if(isNaN(rating) || isNaN(z)) {
              inputsValid = false;
              break;
          }

          const currentRated = rating / (V * 1.732);
          const currentSC = currentRated * 100 / z;
          const currentInrush = currentRated * 12;

          // Add to totals
          totalHvRated += currentRated;
          totalShortCircuit += currentSC;
          totalInrush += currentInrush;

          // Create row for individual table
          txRowsHTML += `
            <tr>
                <td>TX ${i+1}</td>
                <td>${rating}</td>
                <td>${z}</td>
                <td>${currentRated.toFixed(2)} A</td>
                <td>${currentSC.toFixed(2)} A</td>
                <td>${currentInrush.toFixed(2)} A</td>
            </tr>
          `;
      }

      if(!inputsValid) {
          alert("Please fill all Transformer Rating and Impedance fields.");
          return;
      }

      // Add Summary Row to Individual Table
      txRowsHTML += `
        <tr style="font-weight:bold; background-color:#f0fdf4;">
            <td colspan="3" style="text-align:right;">Total Sum</td>
            <td>${totalHvRated.toFixed(2)} A</td>
            <td>${totalShortCircuit.toFixed(2)} A</td>
            <td>${totalInrush.toFixed(2)} A</td>
        </tr>
      `;

      // Update Individual TX Table
      txTableBody.innerHTML = txRowsHTML;

      // 1. Base Calculations
      const consumerLoad = demand / (V * 1.732);
      const inrushCurrent = totalInrush; // Use summed inrush

      // 2. Primary Current Settings (Ideal)
      const I1 = consumerLoad * (100 + overload) / 100; // Load + Margin
      const I5 = 0.9 * totalShortCircuit;
      const I3 = 0.2 * totalHvRated;
      const I4 = 1.0 * totalHvRated;

      // Display Info
      document.getElementById("consumerLoad").innerText = consumerLoad.toFixed(2) + " A";
      document.getElementById("hvRated").innerText = totalHvRated.toFixed(2) + " A";
      document.getElementById("shortCircuit").innerText = totalShortCircuit.toFixed(2) + " A";
      document.getElementById("inrushCurrent").innerText = inrushCurrent.toFixed(2) + " A";

      // Display Ideal Primaries
      document.getElementById("i1").innerHTML = I1.toFixed(2) + " A";
      document.getElementById("i2").innerHTML = "<i>See Below</i>"; 
      document.getElementById("i5").innerHTML = I5.toFixed(2) + " A";
      document.getElementById("i3").innerHTML = I3.toFixed(2) + " A";
      document.getElementById("i4").innerHTML = I4.toFixed(2) + " A";

      document.getElementById("results").style.display = "block";

      if(relayChoice) {
        applyRelayLogic(I1, I3, I4, I5, inrushCurrent, totalShortCircuit, ctr);
      }
    }

    function applyRelayLogic(I1, I3, I4, I5, inrush, sc, ctr) {
      document.getElementById("relaySpecificResult").style.display = "block";
      const labelCell = document.getElementById("settingLabel");

      // Helper to convert Primary to Secondary
      const toSec = (p) => p / ctr;

      // Determine Time Delay and I>> Logic
      let timeI2 = 0;
      let primaryI2 = 0;
      let logicNote = "";

      if (relayChoice === "ashida") {
        timeI2 = 0.05; // 50ms (Fast)
      } else {
        timeI2 = 0.20; // 200ms (Slow)
      }

      // --- Inrush Logic ---
      if (timeI2 < 0.1) {
        primaryI2 = 1.25 * inrush;
        logicNote = "Time < 100ms. Setting = 1.25 × Inrush";
      } else {
        primaryI2 = 0.60 * sc; 
        logicNote = "Time ≥ 100ms. Setting = 0.6 × Short Ckt";
      }

      // Update Ideal I>> Display
      document.getElementById("i2").innerText = primaryI2.toFixed(2) + " A";

      // --- APPLY TO RELAYS ---
      if (relayChoice === "ashida") {
        labelCell.innerText = "Setting (Primary)";
        labelCell.style.color = "#d97706"; 
        
        let tapI1 = findNearestHigher(toSec(I1), ashidaData["I>"]);
        let tapI2 = findNearestHigher(toSec(primaryI2), ashidaData["I>>"]);
        let tapI3 = findNearestHigher(toSec(I3), ashidaData["Ie>"]);
        let tapI4 = findNearestHigher(toSec(I4), ashidaData["Ie>>"]);

        document.getElementById("ri1").innerText = (tapI1 * ctr).toFixed(2) + " A";
        document.getElementById("ri2").innerText = (tapI2 * ctr).toFixed(2) + " A";
        document.getElementById("ri5").innerText = "-"; 
        document.getElementById("ri3").innerText = (tapI3 * ctr).toFixed(2) + " A";
        document.getElementById("ri4").innerText = (tapI4 * ctr).toFixed(2) + " A";
        
        document.getElementById("rt1").innerText = "0.1 (NI)";
        document.getElementById("rt2").innerText = timeI2 + " s";
        document.getElementById("rt5").innerText = "-";
        document.getElementById("rt3").innerText = "0.1 (NI)";
        document.getElementById("rt4").innerText = "0.05 s";
      } 
      else {
        // Micom & REF615 Logic
        labelCell.innerText = "Pickup (Sec)";
        labelCell.style.color = "#374151";

        document.getElementById("ri1").innerText = clamp(toSec(I1), 0.1, 40).toFixed(2);
        document.getElementById("ri2").innerText = clamp(toSec(primaryI2), 0.1, 40).toFixed(2);
        document.getElementById("ri5").innerText = clamp(toSec(I5), 0.1, 40).toFixed(2);
        document.getElementById("ri3").innerText = clamp(toSec(I3), 0.1, 40).toFixed(2);
        document.getElementById("ri4").innerText = clamp(toSec(I4), 0.1, 40).toFixed(2);
        
        document.getElementById("rt1").innerText = "0.1 (NI)";
        document.getElementById("rt2").innerText = timeI2 + " s";
        document.getElementById("rt5").innerText = "0.05 s";
        document.getElementById("rt3").innerText = "0.1 (NI)";
        document.getElementById("rt4").innerText = "0.05 s";
      }
      
      document.getElementById("logicMsg").innerText = logicNote;
    }

    function selectRelay(name) {
      relayChoice = name;
      document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      event.target.classList.add('active');
      calculate(); 
    }

    function spawnHearts() {
      for (let i = 0; i < 8; i++) {
        const heart = document.createElement("div");
        heart.className = "heart";
        heart.textContent = "❤️";
        document.body.appendChild(heart);
        const credits = document.querySelector(".credits span");
        const rect = credits.getBoundingClientRect();
        heart.style.left = (rect.left + rect.width/2 + (Math.random()*40-20)) + "px";
        heart.style.top = rect.top + "px";
        setTimeout(() => heart.remove(), 1500);
      }
    }
  </script>
</body>
</html>